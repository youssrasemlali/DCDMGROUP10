---
title: "clean_data"
format: html
---


```{r}
# Set working directory#
getwd()

# Define folder path#
folder_path <- "/Users/youssrasemlali/Desktop/DCDMGROUP10/Group10/"

# Loading datasets#
raw_file <- file.path(folder_path, "collated_raw_impc_data.csv")
sop_file <- file.path(folder_path, "IMPC_SOP.csv")

raw_data <- read.csv(raw_file, stringsAsFactors = FALSE)
sop <- read.csv(sop_file, stringsAsFactors = FALSE)

#Removing duplicate rows#
duplicate_rows <- duplicated(raw_data)
cleaned_data <- raw_data[!duplicate_rows, ]
removed_duplicates <- raw_data[duplicate_rows, ]

#Save both removes duplicates and clean data subset#
write.csv(cleaned_data, file.path(folder_path, "IMPC_noDuplicates.csv"), row.names = FALSE)
write.csv(removed_duplicates, file.path(folder_path, "IMPC_duplicatesRemoved.csv"), row.names = FALSE)


```


```{r}
#Cleaning according to SOP rules#

# Define folder path#
folder_path <- "/Users/youssrasemlali/Desktop/DCDMGROUP10/Group10/"

# Reload data with no duplicates#
data <- read.csv(file.path(folder_path, "IMPC_noDuplicates.csv"), stringsAsFactors = FALSE)

# Creating copy for cleaning#
cleaned_data <- data

# Standardise cases#
cleaned_data$gene_accession_id <-toupper(cleaned_data$gene_accession_id)
cleaned_data$gene_symbol <-toupper(cleaned_data$gene_symbol)
cleaned_data$mouse_strain <-toupper(cleaned_data$mouse_strain)
cleaned_data$parameter_id <-toupper(cleaned_data$parameter_id)

cleaned_data$mouse_life_stage <- stringr::str_to_sentence(cleaned_data$mouse_life_stage)
cleaned_data$parameter_name <- stringr::str_to_sentence(cleaned_data$parameter_name)

# Validate the values based on the SOP remarks#
mouse_strain_values <- toupper(c("C57BL","B6J","C3H","129V"))
mouse_life_values<- stringr::str_to_sentence(c("E12.5","E15.5","E18.5","E9.5","Early adult","Late adult","Middle aged adult"))

valid_strain <- toupper(cleaned_data$mouse_strain) %in% mouse_strain_values
valid_life <- cleaned_data$mouse_life_stage %in% mouse_life_values

#Vector to mark valid rows#
valid_rows <- rep(TRUE, nrow(cleaned_data))

#Function for string length rules#
check_length <- function(column, min_len, max_len) {
  nchar_val <- nchar(as.character(column))
  return(nchar_val >= min_len & nchar_val <= max_len)
}

# Applying SOP rules 
valid_rows <- valid_rows & (nchar(as.character(cleaned_data$analysis_id)) == 15)
valid_rows <- valid_rows & check_length(cleaned_data$gene_accession_id, 9, 11)
valid_rows <- valid_rows & check_length(cleaned_data$gene_symbol, 1, 13)
valid_rows <- valid_rows & check_length(cleaned_data$mouse_strain, 3, 5)
valid_rows <- valid_rows & check_length(cleaned_data$mouse_life_stage, 4, 17)
valid_rows <- valid_rows & check_length(cleaned_data$parameter_id, 15, 20)
valid_rows <- valid_rows & check_length(cleaned_data$parameter_name, 2, 74)

valid_rows <- valid_rows & valid_strain
valid_rows <- valid_rows & valid_life

cleaned_data$pvalue <- suppressWarnings(as.numeric(cleaned_data$pvalue))
valid_rows <- valid_rows & !is.na(cleaned_data$pvalue)
valid_rows <- valid_rows & (cleaned_data$pvalue >= 0 & cleaned_data$pvalue <= 1)


```

```{r}

#Splitting into valid and invalid rows#
final_cleaned <- cleaned_data[valid_rows, ]
removed_rows <- cleaned_data[!valid_rows, ]

#Saved outputs#

write.csv(final_cleaned, file.path(folder_path, "IMPC_cleaned_data.csv"), row.names = FALSE)
write.csv(removed_rows, file.path(folder_path, "IMPC_removed_data.csv"), row.names = FALSE)
```

```{r}
#Summary showing comparing rows in different data sets# 
cat("Total rows:", nrow(cleaned_data), "\n")
cat("Valid rows (kept):", nrow(final_cleaned), "\n")
cat("Invalid rows (removed):", nrow(removed_rows), "\n")
```

